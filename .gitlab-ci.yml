stages:
  - review
  - test
  - validate
  - deploy
  - e2e-tests

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ui/node_modules/

UI unit tests:
  image: node:10.15.1-alpine
  stage: test
  before_script:
    - cd ui/
    - npm install
  script:
    - npm run build
    - npm test -- --coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/
  artifacts:
    expire_in: 1 month
    paths:
      - ui/coverage

API unit tests:
  image: golang:1.11.5
  stage: test
  script:
    - go test $(go list ./api/...) -v -coverprofile coverage.out
    - go tool cover -html=coverage.out -o api/coverage.html
  coverage: /^coverage:\s(\d+(?:\.\d+)?%)/
  artifacts:
    expire_in: 1 month
    paths:
      - api/coverage.html

validate unit tests:
  image: golang:1.11.5
  stage: test
  script:
    - go test $(go list ./validate/...) -v -coverprofile coverage.out
    - go tool cover -html=coverage.out -o validate/coverage.html
  coverage: /^coverage:\s(\d+(?:\.\d+)?%)/
  artifacts:
    expire_in: 1 month
    paths:
      - validate/coverage.html

validate API definitions:
  image: golang:1.11.5
  stage: validate
  before_script:
    - cd validate
  script:
    - go run ./cmd/don-validate/main.go
  only:
    changes:
      - data/**/*

deploy_review:
  stage: review
  image: nlxio/deployer
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: tcp://localhost:2375
  before_script:
    - docker info
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  script:
    - helm upgrade --install $CI_ENVIRONMENT_SLUG ./helm/don --set "apiImage=registry.gitlab.com/commonground/developer.overheid.nl/api:1070f8d-dirty" --set "uiImage=registry.gitlab.com/commonground/developer.overheid.nl/ui:6c239ae-dirty" --set domain=$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN --namespace $CI_ENVIRONMENT_SLUG
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN
  tags:
    - cluster
    - kubernetes
  only:
    - branches
  except:
    - master

deploy:
  stage: deploy
  tags:
    - nlx-privileged
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN registry.gitlab.com
  script:
    - skaffold run --profile release --profile deploy-${CI_ENVIRONMENT_NAME}
  environment:
    name: prod
  only:
    - master

E2E tests:
  image: buildkite/puppeteer:latest
  stage: e2e-tests
  before_script:
    - cd e2e-tests
    - npm install
  script:
    - npm test
  only:
    - master
  artifacts:
    expire_in: 1 month
    paths:
      - e2e-tests/screenshots

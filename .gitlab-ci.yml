image: docker:stable

services:
  - docker:dind

stages:
  - validate
  - build
  - test
  - release
  - review
  - e2e-tests
  - deploy

variables:
  IMAGE_PREFIX: "$CI_REGISTRY/$CI_PROJECT_PATH"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://localhost:2375

.validate:
  image: golang:1.11.5
  before_script:
    - cd validate
  only:
    changes:
      - data/**/*
      - validate/**/*

validate unit tests:
  extends: .validate
  stage: test
  script:
    - go test $(go list ./...) -v -coverprofile coverage.out
  coverage: /^coverage:\s(\d+(?:\.\d+)?%)/

validate API definitions:
  extends: .validate
  stage: validate
  script:
    - go run ./cmd/don-validate/main.go

## UI ##
.ui:
  only:
    changes:
      - ui/**/*
  tags:
    - cluster
    - kubernetes
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - export IMAGE_UI=${IMAGE_PREFIX}/ui

Build UI:
  extends: .ui
  stage: build
  script:
    - docker pull $IMAGE_UI:master || true
    - docker pull $IMAGE_UI:${CI_COMMIT_REF_SLUG}-build || true
    - docker build --target build --cache-from $IMAGE_UI:$CI_COMMIT_REF_SLUG --tag $IMAGE_UI:${CI_COMMIT_SHA}-tmp --tag $IMAGE_UI:${CI_COMMIT_REF_SLUG}-build -f ui/Dockerfile .
    - docker push $IMAGE_UI:${CI_COMMIT_SHA}-tmp
    - docker push $IMAGE_UI:${CI_COMMIT_REF_SLUG}-build

Test UI:
  extends: .ui
  stage: test
  script:
    - docker pull $IMAGE_UI:${CI_COMMIT_SHA}-tmp
    - docker run $IMAGE_UI:${CI_COMMIT_SHA}-tmp npm test -- --coverage
  coverage: /All\sfiles.*?\s+(\d+.\d+)/

Release UI:
  extends: .ui
  stage: release
  script:
    - docker pull $IMAGE_UI:${CI_COMMIT_SHA}-tmp
    - docker build --target webserver --cache-from $IMAGE_UI:${CI_COMMIT_SHA}-tmp --tag $IMAGE_UI:$CI_COMMIT_SHA --tag $IMAGE_UI:$CI_COMMIT_REF_SLUG -f ui/Dockerfile .
    - docker push $IMAGE_UI:$CI_COMMIT_SHA
    - docker push $IMAGE_UI:$CI_COMMIT_REF_SLUG

## API ##
.api:
  only:
    changes:
      - api/**/*
  tags:
    - cluster
    - kubernetes
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - export IMAGE_API=${IMAGE_PREFIX}/api

Build API:
  extends: .api
  stage: build
  script:
    - docker pull $IMAGE_API:master || true
    - docker pull $IMAGE_API:${CI_COMMIT_REF_SLUG}-build || true
    - docker build --target build --cache-from $IMAGE_API:$CI_COMMIT_REF_SLUG --tag $IMAGE_API:${CI_COMMIT_SHA}-tmp --tag $IMAGE_API:${CI_COMMIT_REF_SLUG}-build -f api/Dockerfile .
    - docker push $IMAGE_API:${CI_COMMIT_SHA}-tmp
    - docker push $IMAGE_API:${CI_COMMIT_REF_SLUG}-build

Test API:
  extends: .api
  stage: test
  script:
    - docker pull $IMAGE_API:${CI_COMMIT_SHA}-tmp
    - docker run $IMAGE_API:${CI_COMMIT_SHA}-tmp go test -v -coverprofile coverage.out ./...
  coverage: /^coverage:\s(\d+(?:\.\d+)?%)/

Release API:
  extends: .api
  stage: release
  script:
    - docker pull $IMAGE_API:${CI_COMMIT_SHA}-tmp
    - docker build --cache-from $IMAGE_API:${CI_COMMIT_SHA}-tmp --tag $IMAGE_API:$CI_COMMIT_SHA --tag $IMAGE_API:$CI_COMMIT_REF_SLUG -f api/Dockerfile .
    - docker push $IMAGE_API:$CI_COMMIT_SHA
    - docker push $IMAGE_API:$CI_COMMIT_REF_SLUG

Deploy Review App:
  stage: review
  image: registry.gitlab.com/commonground/don-deployer:latest
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - export IMAGE_API=${IMAGE_PREFIX}/api
    - export IMAGE_UI=${IMAGE_PREFIX}/ui
  script:
    - echo -e -n "https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN" > ci_environment_url.txt
    - helm delete --purge $CI_ENVIRONMENT_SLUG || true
    - helm upgrade --install $CI_ENVIRONMENT_SLUG ./helm/don --set "gitlabUrl=$GITLAB_URL" --set "gitlabAccessToken=$GITLAB_ACCESS_TOKEN" --set-string "gitlabProjectId=$GITLAB_PROJECT_ID" --set "imagePullPolicy=Always" --set "apiImage=$IMAGE_API:$CI_COMMIT_REF_SLUG" --set "uiImage=$IMAGE_UI:$CI_COMMIT_REF_SLUG" --set domain=$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN --set name=$CI_ENVIRONMENT_SLUG --namespace developer-overheid-nl
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN
    on_stop: stop_review_app
  tags:
    - cluster
    - kubernetes
  only:
    - branches
  except:
    - master
  artifacts:
    paths:
      - ci_environment_url.txt

stop_review_app:
  stage: review
  image: registry.gitlab.com/commonground/don-deployer:latest
  variables:
    GIT_STRATEGY: none
  script:
    - helm delete $CI_ENVIRONMENT_SLUG
  environment:
    name: review/$CI_COMMIT_REF_NAME
    url: https://$CI_ENVIRONMENT_SLUG.$KUBE_INGRESS_BASE_DOMAIN
    action: stop

E2E tests:
  image: buildkite/puppeteer:latest
  stage: e2e-tests
  before_script:
    - export URL=$(cat ci_environment_url.txt)
    - cd e2e-tests
    - npm install
  script:
    - npm test
  artifacts:
    expire_in: 1 month
    paths:
      - e2e-tests/screenshots

deploy:
  stage: deploy
  image: registry.gitlab.com/commonground/don-deployer:latest
  before_script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - export IMAGE_API=${IMAGE_PREFIX}/api
    - export IMAGE_UI=${IMAGE_PREFIX}/ui
  script:
    - helm delete --purge don-prod || true
    - helm upgrade --install don-prod ./helm/don --set "gitlabUrl=$GITLAB_URL" --set "gitlabAccessToken=$GITLAB_ACCESS_TOKEN" --set-string "gitlabProjectId=$GITLAB_PROJECT_ID" --namespace don-prod
  when: manual
  environment:
    name: prod
    url: https://don.commonground.nl
  tags:
    - nlx-privileged
